
<input class="tab-button pc" type="radio" name="attr_tab" value="pc" checked="checked"><span>PJ</span>
<input class="tab-button roleplay" type="radio" name="attr_tab" value="roleplay"><span>Roleplay</span>
<input class="tab-button npc" type="radio" name="attr_tab" value="npc"><span>PNJ</span>

<hr/>

<input type="hidden" name="attr_global" value="0"/>

<div class="page pc">
    
    <input type="text" name="attr_character_name" class="transparent-input editable-title" placeholder="Nom"/>
	<hr/>
	<div class="2colrow">
		<div class="col">
			<h2>Stress</h2>
			<span class="blessure">Stress physique</span>
			<input type="number" name='attr_stresspnum1' class='sheet-short stress-val' >
			<input type="number" name='attr_stresspnum2' class='sheet-short stress-val' >
			<input type="number" name='attr_stresspnum3' class='sheet-short stress-val' >
			<br/>
			<span class="blessure" style="font-weight: normal;">Cases :</span>
			<input class="stressbox" type="checkbox" name="attr_stressp1" >
			<input class="stressbox" type="checkbox" name="attr_stressp2" >
			<input class="stressbox" type="checkbox" name="attr_stressp3" ><br/>
			<hr/>
			<span class="blessure">Stress mental</span>
			<input type="number" name='attr_stressmnum1' class='sheet-short stress-val' >
			<input type="number" name='attr_stressmnum2' class='sheet-short stress-val' >
			<input type="number" name='attr_stressmnum3' class='sheet-short stress-val' >
			<br/>
			<span class="blessure" style="font-weight: normal;">Cases :</span>
			<input class="stressbox" type="checkbox" name="attr_stressm1" >
			<input class="stressbox" type="checkbox" name="attr_stressm2" >
			<input class="stressbox" type="checkbox" name="attr_stressm3" ><br/>


		</div>
		<div class="col">
			<h2>Blessures</h2>
			<span class="blessure">Blessure mineure (4)</span>
			<input type="text" class="2coltext" name="attr_minorblessure" />
			<input class="" type="checkbox" name="attr_minorblessurerecover" ><br/>
			<span class="blessure">Blessure modérée (6)</span>
			<input type="text" class="2coltext" name="attr_mediumblessure" />
			<input class="" type="checkbox" name="attr_mediumblessurerecover" ><br/>
			<span class="blessure">Blessure majeure (8)</span>
			<input type="text" class="2coltext" name="attr_majorblessure" />
			<input class="" type="checkbox" name="attr_majorblessurerecover" ><br/>

            
		</div>
	</div>
	<hr/>
	<div class="2colrow">
	
		<div class="col">
       	    <label>Armure</label>
            <span class='dee'>+</span><input class="transparent-input" type="number" name="attr_BonusArmure" /><span class='dee'>=</span><input type="number" name="attr_Armure" readonly />
		</div>
		<div class="col">
		
        	<label>Résistance Mag.</label>
        	<span class='dee'>+</span><input class="transparent-input" type="number" name="attr_BonusResistance" /><span class='dee'>=</span><input type="number" name="attr_Resistance" readonly />
		</div>
	
	</div>
	<div class="2colrow">
		<div class="col">
		
			<label>Initiative</label>
			<input type="hidden" name="attr_initiativebonus"/>

			<button type='roll' name='roll_intiative' value='&{template:default} {{name=Jet initiative (+@{initiativebonus})}} {{Jet=[[1D8+@{initiativebonus} &{tracker}]] [[ 1t[Jet-secondaire] ]] }}'></button>
		</div>
		<div class="col">
		</div>
	</div>

    <hr/>
    <h1>Compétences</h1>
	<button type='roll' name='roll_specialist' value='&{template:default} {{name=Jet spécialiste (+4)}} {{Jet=[[1D8+4]] [[ 1t[Jet-secondaire] ]] }}'></button>
	<span class="skill-tier">Spécialiste (+4)</span>
    <input type="text" class="competence" name="attr_comp1" />
	<br/>
	<button type='roll' name='roll_expert' value='&{template:default} {{name=Jet expert (+3)}} {{Jet=[[1D8+3]] [[ 1t[Jet-secondaire] ]] }}'></button>
	<span class="skill-tier">Expert (+3)</span>
    <input type="text" class="competence init"  name="attr_comp10"  />
    <input type="text" class="competence"  name="attr_comp11"  />
    <input type="text" class="competence"  name="attr_comp12"  />
	<br/>
	<button type='roll' name='roll_confirme' value='&{template:default} {{name=Jet confirmé (+2)}} {{Jet=[[1D8+2]] [[ 1t[Jet-secondaire] ]] }}'></button>
	<span class="skill-tier">Confirmé (+2)</span>
    <input type="text" class="competence init"  name="attr_comp20"  />
    <input type="text" class="competence init"  name="attr_comp21"  />
    <input type="text" class="competence init"  name="attr_comp22"  />
    <input type="text" class="competence"  name="attr_comp23"  />
    <input type="text" class="competence"  name="attr_comp24"  /><br/>
	<button type='roll' name='roll_initie' value='&{template:default} {{name=Jet initié (+1)}} {{Jet=[[1D8+1]] [[ 1t[Jet-secondaire] ]] }}'></button>
	<span class="skill-tier">Initié (+1)</span>
    <input type="text" class="competence init"  name="attr_comp30"  />
    <input type="text" class="competence init"  name="attr_comp31"  />
    <input type="text" class="competence init"  name="attr_comp32"  />
    <input type="text" class="competence init"  name="attr_comp33"  />
    <input type="text" class="competence init"  name="attr_comp34"  />
    <input type="text" class="competence"  name="attr_comp35"  /><br/>
	<button type='roll' name='roll_normal' style="display:none;" value='&{template:default} {{name=Jet normal (+0)}} {{Jet=[[1D8]] [[ 1t[Jet-secondaire] ]] }}'></button>
	<span class="skill-tier" style="margin-left: 32px;"></span>
    <input type="text" class="competence"  name="attr_comp40"  />
    <input type="text" class="competence"  name="attr_comp41"  />
    <input type="text" class="competence"  name="attr_comp42"  />
    <input type="text" class="competence"  name="attr_comp43"  />
    <input type="text" class="competence"  name="attr_comp44"  />
    <input type="text" class="competence"  name="attr_comp45"  /><br/>
	<button type='roll' name='roll_normal' value='&{template:default} {{name=Jet normal (+0)}} {{Jet=[[1D8]] [[ 1t[Jet-secondaire] ]] }}'></button>
	<span class="skill-tier">Normal (+0)</span>
	
	<input type="hidden" name="attr_physiqueamount"/>
	<input type="hidden" name="attr_precisionamount"/>
	<input type="hidden" name="attr_meleeamount"/>
	<input type="hidden" name="attr_arcaneamount"/>
    <hr/>
    <div class="dons">
        
        <h1>Particularités</h1>
        <div class="2colrow">
            <div class="col" style="width: 30%;">
                <h2>Aspects (Passifs)</h2>
                
            	<div class="aspects">
            	    <div class="top">
                        <span class="label" style="margin-left:10px;width: 224px;">Nom de l'aspect</span>
                    </div>
                    <fieldset class="repeating_aspects">
                        <div class="display">
                            <input type="text" class="transparent-input" name="attr_aspect_nom" style="width:248px; font-weight:bold;"/>
                            <textarea class="transparent-input desc-don" style="width:240px; height: 18px; margin-top:2px;min-height: 17px; resize: vertical;"
                                placeholder="Description"></textarea>
                        </div>
                    </fieldset>
                </div>
            </div>
            <div class="col" style="width: 65%;">
                <h2>Dons (Actifs)</h2>
                
            	<div class="subdons">
            	    <div class="top">
                        <span class="label" style="margin-left:10px;width: 90%;">Nom du don</span>
                    </div>
                    <fieldset class="repeating_dons">
                        <div class="display">
                            <input type="text" class="subdon-display transparent-input" name="attr_subdon_nom" style="width:408px; font-weight:bold;"/>
                            <textarea class="transparent-input desc-don" style="width:400px;height: 34px; margin-top:2px;min-height: 17px; resize: vertical;"
                                placeholder="Description"></textarea>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>
    </div>
    <hr/>
    <h1>Equipements</h1>
    <div class="attacks" style="position: relative; float:left; margin-right: 10px;">
        <h2 class="label" style="margin-top: 0px; bottom: 0px;">Armes</h2>
        <div class="top">
            <span class="label" style="width: 90px; padding-left:5px;">Nom de l'arme</span>
            <span class="label" style="width: 55px;">Dommages</span>
            <span class="label" style="width: 45px;">Portée</span>
        </div>
        <fieldset class="repeating_attack">
            <div class="attack">
                <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"><span>y</span>
                <div class="options">
                    <div class="row">
                        <span>Nom de l'arme :</span>
                        <input type="text" name="attr_atkname" />
                    </div>
                    <div class="row">
                        <span>Attaque :</span>
						<select name="attr_atkattr_base">
							<option value="@{physiqueamount}" class="forlbl">Physique</option>
							<option value="@{precisionamount}" class="dexlbl">Précision</option>
							<option value="@{meleeamount}" class="agilbl" selected>Combat mêlée</option>
							<option value="@{arcaneamount}" class="conlbl">Arcane</option>
						</select>
                        <span>+</span>
                        <input type="text" class="num" name="attr_atkmod" placeholder="0">
                    </div>
                    <div class="row">
                        <span>Portée :</span>
                        <input type="text" name="attr_atkrange" placeholder="Corps-à-corps/X m" style="width: 170px;">
                    </div>
                    <div class="row">
                        <span>Dommages :</span>
                        <input type="text" name="attr_dmgbase" placeholder="0" style="width: 50px;">
                    </div>
                    <div class="row">
                        <span>Description :</span>
                        <textarea name="attr_atk_desc" class="transparent-input" ></textarea>
                    </div>
                </div>
                <div class="display">
                    <span name="attr_atkname" style="width: 95px;"></span>
                    <input type="text" name="attr_dmgbase" style="width: 60px;" value="">
                    <span name="attr_atkrange" style="width: 30px;"></span>
                    <button type="roll" name="roll_attack" value="&{template:default} {{name=Jet de @{atkname} (+?{Bonus ?|0})}} {{Jet=[[1D8+?{Bonus ?|0}+@{atkattr_base}+@{atkmod}]] [[ 1t[Jet-secondaire] ]] }} {{Dégâts=+@{dmgbase}}}"></button>
                </div>
            </div>
        </fieldset>
    </div>
    <div class="armors" style="position: relative; float:left; margin-right: 10px;">
        <h2 class="label" style="margin-top: 0px; bottom: 0px;">Armures</h2>
        <div class="top">
            <span class="label" style="width: 7px;">E?</span>
            <span class="label" style="width: 93px;">Nom de l'armure</span>
            <span class="label" style="width: 40px;">Physique</span>
            <span class="label" style="width: 40px;">Magique</span>
        </div>
        <fieldset class="repeating_allarmors">
            <div class="armor">
                <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"><span>y</span>
                <div class="options">
                    <div class="row">
                        <span>Nom de l'armure :</span>
                        <input type="text" name="attr_armorname">
                    </div>
                    <div class="row">
                        <span>Armure :</span>
                        <input type="text" name="attr_armor_value" placeholder="" style="width: 50px;">
                        <span style="margin-left:20px;">Résistance :</span>
                        <input type="text" name="attr_resist_value" placeholder="" style="width: 50px;">
                        <span>Malus réactivité :</span>
                        <input type="text" name="attr_armor_malus" placeholder="" style="width: 50px;">
                    </div>
                    <div class="row">
                        <span>Attaque :</span>
						<select name="attr_atkattr_base">
							<option value="@{physiqueamount}" class="forlbl">Physique</option>
							<option value="@{precisionamount}" class="dexlbl">Précision</option>
							<option value="@{meleeamount}" class="agilbl" selected>Combat mêlée</option>
							<option value="@{arcaneamount}" class="conlbl">Arcane</option>
						</select>
                        <span>+</span>
                        <input type="text" class="num" name="attr_atkmod" placeholder="0">
                    </div>
                    <div class="row">
                        <span>Dommages :</span>
                        <input type="text" name="attr_dmgbase" placeholder="-" style="width: 50px;">
                    </div>
                    <div class="row">
                        <span>Description :</span>
                        <textarea name="attr_atk_desc" class="transparent-input" ></textarea>
                    </div>
                </div>
                <div class="display">
                    <input type="checkbox" name="attr_armor_equipped"/>
                    <span name="attr_armorname" style="width: 90px;"></span>
                    <span name="attr_armor_value" style="width: 35px;"></span>
                    <span name="attr_resist_value" style="width: 35px;"></span>
                    <button type="roll" name="roll_attack" value="&{template:default} {{name=Jet de @{armorname} (+?{Bonus ?|0})}} {{Jet=[[1D8+?{Bonus ?|0}+@{atkattr_base}+@{atkmod}]] [[ 1t[Jet-secondaire] ]] }} {{Dégâts=+@{dmgbase}}}"></button>
                </div>
            </div>
        </fieldset>
    </div>
    <div class="equipment">
        <h2 class="label" style="margin-left: 5px; bottom: 0px;">Autres</h2>
        <h6 class="label" style="margin-left: 5px; bottom: 0px;">Pièces :</h6>
        <div class="money">
            <div class="coin coper">
                <span class="label">Cuivre</span>
                <input type="text" name="attr_cp" title="10 => 1 PA">
            </div>
            <div class="coin silver">
                <span class="label">Argent</span>
                <input type="text" name="attr_sp" title="10 => 1 PO">
            </div>
            <div class="coin gold">
                <span class="label">Or</span>
                <input type="text" name="attr_gp" title="10 => 1 PP">
            </div>
            <div class="coin platine">
                <span class="label">Platine</span>
                <input type="text" name="attr_pp">
            </div>
        </div>
        <h6 class="label" style="margin-left: 5px; bottom: 0px;">Objets divers :</h6>
        <div class="complex">
            <div class="top" style="height: auto;">
                <span style="width: 50px; text-align: center; display:inline-block;">Quantité</span>
                <span style="width: 150px; text-align: left; display:inline-block;">Nom de l'objet</span>
            </div>
            <fieldset class="repeating_inventory">
                <input type="hidden" class="equippedflag" name="attr_equipped">
                <div class="item">
                    <input class="weight" type="text" name="attr_itemcount" value="1">
                    <input class="name" type="text" name="attr_itemname">
                </div>
            </fieldset>
        </div>
    </div>
    <input type="hidden" name="attr_TotalArmor"/>
    <input type="hidden" name="attr_TotalResist"/>
    <input type="hidden" name="attr_TotalAgiMalus"/>
    <hr/>
</div>
<div class="page roleplay">
    <h1>Roleplay</h1>
    <div class="2colrow">
        <div class="col">
	        <label class="background-label">Race</label><input type="text" class="transparent-input" name="attr_race" /><br/>
	        <label class="background-label">Langues</label><input type="text" class="transparent-input" name="attr_langues" />
        </div>
        <div class="col">
	        <label class="background-label">Taille</label><input type="text" class="transparent-input" name="attr_taille" /><br/>
	        <label class="background-label">Poids</label><input type="text" class="transparent-input" name="attr_poids" /><br/>
	        <label class="background-label">Âge</label><input type="text" class="transparent-input" name="attr_age" />
        </div>
	</div>
    <div class="2colrow">
        <div class="col">
            <div class="background">
                <span>Personnalité (qualités, défauts, caractère)</span>
                <textarea name="attr_personnalite" class="transparent-input" ></textarea>
            </div>
        </div>
        <div class="col">
            <div class="background">
                <span>Contacts, alliés et ennemis</span>
                <textarea name="attr_contacts" class="transparent-input" ></textarea>
            </div>
        </div>
    </div>
    <div class="2colrow">
        <div class="col">
            <div class="background">
                <span>Goûts</span>
                <textarea name="attr_gouts" class="transparent-input" ></textarea>
            </div>
        </div>
        <div class="col">
            <div class="background">
                <span>Peurs</span>
                <textarea name="attr_peurs" class="transparent-input" ></textarea>
            </div>
        </div>
    </div>
    <div class="background">
        <span>Histoire</span>
        <textarea name="attr_historique" class="transparent-input" style="font-style:italic;" ></textarea>
    </div>
    <div class="background">
        <span>Notes</span>
        <textarea name="attr_notes" class="transparent-input" ></textarea>
    </div>
</div>

<!-- Script Worker -->
<script type="text/worker">

/* ===== PARAMETERS ==========
destination = the name of the attribute that stores the total quantity
section = name of repeating fieldset, without the repeating_
fields = the name of the attribute field to be summed
      can be a single attribute: 'weight'
      or an array of attributes: ['weight','number','equipped']
multiplier (optional) = a multiplier to to entire fieldset total. For instance, if summing coins of weight 0.02, might want to multiply the final total by 0.02.
*/
const repeatingSum = (destination, section, fields, multiplier = 1) => {
    if (!Array.isArray(fields)) fields = [fields];
    getSectionIDs(`repeating_${section}`, idArray => {
        const attrArray = idArray.reduce( (m,id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))],[]);
        getAttrs(attrArray, v => {
            console.log("===== values of v: "+ JSON.stringify(v) +" =====");
                 // getValue: if not a number, returns 1 if it is 'on' (checkbox), otherwise returns 0..
            const getValue = (section, id,field) => parseFloat(v[`repeating_${section}_${id}_${field}`], 10) || (v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : 0); 
            const sumTotal = idArray.reduce((total, id) => total + fields.reduce((subtotal,field) => subtotal * getValue(section, id,field),1),0);
            console.log(sumTotal*multiplier);
            setAttrs({[destination]: sumTotal * multiplier});    
        });
    });
};

/* MAJ PV */
on("change:puissancenpc change:con_d change:con_pip sheet:opened", function() {
    console.log("MAJ PV max");
    getAttrs(["Con_d","Con_pip", "PV_max", "PV", "PuissanceNPC"], function(values) {
        console.log(values);
        let cond = parseInt(values.Con_d, 10) || 0;
        let conpip = parseInt(values.Con_pip, 10) || 0;
        let oldpvmax = parseInt(values.PV_max, 10) || 0;
        let oldpv = parseInt(values.PV, 10) || 0;
        let pnpc = parseInt(values.PuissanceNPC, 10) || 0;
        setAttrs({
            PV_max: Math.max(5, ((pnpc + cond) * 3 + conpip) * 2 + 10),
            PV: Math.max(5, oldpv + (((pnpc + cond) * 3 + conpip) * 2 + 10) - oldpvmax)
        });
    });
});

/* MAJ PE */
on("change:puissancenpc change:pot_d change:pot_pip sheet:opened", function() {
    console.log("MAJ PE max");
    getAttrs(["Pot_d","Pot_pip", "PE_max", "PE", "PuissanceNPC"], function(values) {
        console.log(values);
        let potd = parseInt(values.Pot_d, 10) || 0;
        let potpip = parseInt(values.Pot_pip, 10) || 0;
        let oldpemax = parseInt(values.PE_max, 10) || 0;
        let oldpe = parseInt(values.PE, 10) || 0;
        let pnpc = parseInt(values.PuissanceNPC, 10) || 0;
        setAttrs({
            PE_max: Math.max(0, ((pnpc + potd) * 3 + potpip + 2) * 1),
            PE: Math.max(0, oldpe + (((pnpc + potd) * 3 + potpip + 2) * 1 - oldpemax))
        });
    });
});

/* MAJ Base physique */
on("change:puissancenpc change:bonusbasephy change:for_d change:for_pip change:puissancephysiquecomp_pip change:puissancephysiquecomp_d sheet:opened", function() {
    console.log("MAJ Base Physique");
    getAttrs(["PuissancePhysiqueComp_d","PuissancePhysiqueComp_pip", "For_d", "For_pip", "BonusBasePhy", "PuissanceNPC"], function(values) {
        console.log(values);
        let fds = parseInt(values.For_d, 10) || 0;
        let fpips = parseInt(values.For_pip, 10) || 0;
        let ds = parseInt(values.PuissancePhysiqueComp_d, 10) || 0;
        let pips = parseInt(values.PuissancePhysiqueComp_pip, 10) || 0;
        let bonus = parseInt(values.BonusBasePhy, 10) || 0;
        let pnpc = parseInt(values.PuissanceNPC, 10) || 0;
        setAttrs({
            BasePhy: ds + pnpc + fds + bonus
        });
    });
});

/* MAJ Base magique */
on("change:puissancenpc change:bonusbasemag change:pot_d change:pot_pip change:puissancemagiquecomp_pip change:puissancemagiquecomp_d sheet:opened", function() {
    console.log("MAJ Base magique");
    getAttrs(["PuissanceMagiqueComp_d","PuissanceMagiqueComp_pip", "Pot_d", "Pot_pip", "BonusBaseMag", "PuissanceNPC"], function(values) {
        console.log(values);
        let pds = parseInt(values.Pot_d, 10) || 0;
        let ppips = parseInt(values.Pot_pip, 10) || 0;
        let ds = parseInt(values.PuissanceMagiqueComp_d, 10) || 0;
        let pips = parseInt(values.PuissanceMagiqueComp_pip, 10) || 0;
        let bonus = parseInt(values.BonusBaseMag, 10) || 0;
        let pnpc = parseInt(values.PuissanceNPC, 10) || 0;
        setAttrs({
            BaseMag: ds + pds + pnpc + bonus
        });
    });
});

/* MAJ Armure */
on("change:repeating_allarmors remove:repeating_allarmors sheet:opened", function() {
    repeatingSum("TotalArmor", "allarmors", ["armor_equipped", "armor_value"]);
    repeatingSum("TotalResist", "allarmors", ["armor_equipped", "resist_value"]);
    repeatingSum("TotalAgiMalus", "allarmors", ["armor_equipped", "armor_malus"]);
});

on("change:totalarmor change:bonusarmure change:staminacomp_d sheet:opened", function() {
    console.log("MAJ Armure");
    
    getAttrs(["BonusArmure", "StaminaComp_d", "TotalArmor"], function(values) {
        console.log(values);
        let ba = parseInt(values.BonusArmure, 10) || 0;
        let sc = parseInt(values.StaminaComp_d, 10) || 0;
        let ta = parseInt(values.TotalArmor, 10) || 0;
        setAttrs({
            Armure: Math.floor(ba + sc + ta)
        });
    });
});

on("change:totalresist change:bonusresistance change:volontecomp_d sheet:opened", function() {
    console.log("MAJ Résistance");
    getAttrs(["BonusResistance", "VolonteComp_d", "TotalResist"], function(values) {
        console.log(values);
        let br = parseInt(values.BonusResistance, 10) || 0;
        let vc = parseInt(values.VolonteComp_d, 10) || 0;
        let tr = parseInt(values.TotalResist, 10) || 0;
        setAttrs({
            Resistance: Math.floor(br + vc + tr)
        });
    });
});

/* MAJ Defense */
on("change:puissancenpc change:bonusdefense change:agi_d sheet:opened", function() {
    console.log("MAJ Résistance");
    getAttrs(["BonusDefense", "Agi_d", "PuissanceNPC"], function(values) {
        console.log(values);
        let bd = parseInt(values.BonusDefense, 10) || 0;
        let agid = parseInt(values.Agi_d, 10) || 0;
        let pnpc = parseInt(values.PuissanceNPC, 10) || 0;
        setAttrs({
            Defense: Math.floor(9 + bd + Math.floor((pnpc + agid) / 2))
        });
    });
});

const updatePhysStress = (m) => {
	var v = 0;
	if (m.has("Stamina"))
		v = m.get("Stamina");
	console.log("Update physique stress with " + v);
	setAttrs({
		stresspnum1 : Math.max(0, v-2),
		stresspnum2 : Math.max(1, v),
		stresspnum3 : v+2
	});
};

const updateMentStress = (m) => {

	var v = 0;
	if (m.has("Volonté"))
		v = m.get("Volonté");
	console.log("Update mental stress with " + (v+2));
	setAttrs({
		stressmnum1 : Math.max(0, v-2),
		stressmnum2 : Math.max(1, v),
		stressmnum3 : v+2
	});
};


const updateInitiative = (m) => {
	var r = 0, p = 0;
	if (m.has("Perception"))
		p = m.get("Perception");
	if (m.has("Réaction"))
		r = m.get("Réaction");
	console.log("Update initiative bonus with " + (p + Math.ceil(r/2)));
	setAttrs({
		initiativebonus : p + Math.ceil(r/2)
	});
};


const updateAmounts = (m) => {
	var ph = 0, pr = 0, cm = 0, ar = 0, st = 0, vo = 0;
	if (m.has("Physique"))
		ph = m.get("Physique");
	if (m.has("Précision"))
		pr = m.get("Précision");
	if (m.has("Combat mêlée"))
		cm = m.get("Combat mêlée");
	if (m.has("Arcane"))
		ar = m.get("Arcane");
		
	console.log("Update competences");
	setAttrs({
		physiqueamount : ph,
		precisionamount : pr,
		meleeamount : cm,
		arcaneamount : ar
	});
};

const mapit = (attrs) => {
	var m = new Map();
	
	m.set(attrs.comp30, 1);
	m.set(attrs.comp30, 1);
	m.set(attrs.comp31, 1);
	m.set(attrs.comp32, 1);
	m.set(attrs.comp33, 1);
	m.set(attrs.comp34, 1);
	m.set(attrs.comp40, 1);
	m.set(attrs.comp41, 1);
	m.set(attrs.comp42, 1);
	m.set(attrs.comp43, 1);
	m.set(attrs.comp44, 1);
	m.set(attrs.comp20, 2);
	m.set(attrs.comp21, 2);
	m.set(attrs.comp22, 2);
	m.set(attrs.comp23, 2);
	m.set(attrs.comp24, 2);
	m.set(attrs.comp10, 3);
	m.set(attrs.comp11, 3);
	m.set(attrs.comp12, 3);
	m.set(attrs.comp1, 4);
	
	return m;
};




on("change:comp1 change:comp10 change:comp11 change:comp12 change:comp20 change:comp21 change:comp22 change:comp23 change:comp24 change:comp30 change:comp31 change:comp32 change:comp33 change:comp34 change:comp35 change:comp40 change:comp41 change:comp42 change:comp43 change:comp44 change:comp45 sheet:opened", function() { // TODO
	console.log("MAJ comp");
	
	getAttrs(["comp1", "comp10", "comp11", "comp12", "comp20", "comp21", "comp22", "comp23", "comp24", "comp30", "comp31", "comp32", "comp33", "comp34", "comp35", "comp40", "comp41", "comp42", "comp43", "comp44", "comp45"], function(v) {
		console.log(v);
		var vmap = mapit(v);
		updatePhysStress(vmap);
		updateMentStress(vmap);
		updateInitiative(vmap);
		updateAmounts(vmap);
		
	});
	
});
</script>