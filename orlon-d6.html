
<input class="tab-button pc" type="radio" name="attr_tab" value="pc" checked="checked"><span>PJ</span>
<input class="tab-button roleplay" type="radio" name="attr_tab" value="roleplay"><span>Roleplay</span>
<input class="tab-button npc" type="radio" name="attr_tab" value="npc"><span>PNJ</span>

<hr/>

<input type="hidden" name="attr_global" value="0"/>

<div class="page npc">
    <label>Nom</label><input type="text" name="attr_character_name" />
	<br/>
	<label>Race</label><input type="text" name="attr_rank" />
    <hr/>
     
    <label class="forlbl">Puissance générale NPC</label><input type="number" name='attr_PuissanceNPC' class='sheet-short' value="0" >
    <br/>
    <h2>Jets simplifiées</h2>
    <div class="2colrow">
        <div class="col">
            <label class="forlbl">Force</label><input type="number" name='attr_For_d' class='sheet-short' value="0" >
            <span class='dee'>D+</span>
            <input type="number" name='attr_For_pip' class='sheet-short' value='0' />
            <button type='roll' name='roll_jetFor' class='rollbtn' value='!wwd [[(@{PuissanceNPC}+@{For_d})D6+@{For_pip}]] {{carac=Force}} {{nd=?{Difficulté ?|} }}'></button>
            <br/>
            <label class="dexlbl">Dextérité</label><input type="number" name='attr_Dex_d' class='sheet-short' value="0" />
            <span class='dee'>D+</span>
            <input type="number" name='attr_Dex_pip' class='sheet-short'  value="0" />
            <button type='roll' name='roll_jetDex' value='!wwd [[(@{PuissanceNPC}+@{Dex_d})D6+@{Dex_pip}]] {{carac=Dextérité}} {{nd=?{Difficulté ?|} }}'></button>
            <br/> 
            <label class="agilbl">Agilité</label><input type="number" name='attr_Agi_d' class='sheet-short' value="0">
            <span class='dee'>D+</span>
            <input type="number" name='attr_Agi_pip' class='sheet-short' value="0" >
            <button type='roll' name='roll_jetAgi' value='!wwd [[(@{PuissanceNPC}+@{Agi_d})D6+@{Agi_pip}+@{TotalAgiMalus}]] {{carac=Agilité}} {{nd=?{Difficulté ?|} }}'></button>
            <br/> 
            <label class="conlbl">Constitution</label><input type="number" name='attr_Con_d' class='sheet-short' value="0">
            <span class='dee'>D+</span>
            <input type="number" name='attr_Con_pip' class='sheet-short' value="0" >
            <button type='roll' name='roll_jetCon' value='!wwd [[(@{PuissanceNPC}+@{Con_d})D6+@{Con_pip}]] {{carac=Constitution}} {{nd=?{Difficulté ?|} }}'></button>
            <br/> 
            <label class="intlbl">Intelligence</label><input type="number" name='attr_Int_d' class='sheet-short' value="0">
            <span class='dee'>D+</span>
            <input type="number" name='attr_Int_pip' class='sheet-short' value="0" >
            <button type='roll' name='roll_jetInt' value='!wwd [[(@{PuissanceNPC}+@{Int_d})D6+@{Int_pip}]] {{carac=Intelligence}} {{nd=?{Difficulté ?|} }}'></button>
            <br/> 
            <label class="saglbl">Sagesse</label><input type="number" name='attr_Sag_d' class='sheet-short' value="0">
            <span class='dee'>D+</span>
            <input type="number" name='attr_Sag_pip' class='sheet-short' value="0" >
            <button type='roll' name='roll_jetSag' value='!wwd [[(@{PuissanceNPC}+@{Sag_d})D6+@{Sag_pip}]] {{carac=Sagesse}} {{nd=?{Difficulté ?|} }}'></button>
            <br/> 
            <label class="chalbl">Charisme</label><input type="number" name='attr_Cha_d' class='sheet-short' value="0">
            <span class='dee'>D+</span>
            <input type="number" name='attr_Cha_pip' class='sheet-short' value="0" >
            <button type='roll' name='roll_jetCha' value='!wwd [[(@{PuissanceNPC}+@{Cha_d})D6+@{Cha_pip}]] {{carac=Charisme}} {{nd=?{Difficulté ?|} }}'></button>
            <br/> 
            <label class="potlbl">Potentiel</label><input type="number" name='attr_Pot_d' class='sheet-short' value="0">
            <span class='dee'>D+</span>
            <input type="number" name='attr_Pot_pip' class='sheet-short' value="0" >
            <button type='roll' name='roll_jetPot' value='!wwd [[(@{PuissanceNPC}+@{Pot_d})D6+@{Pot_pip}]] {{carac=Potentiel}} {{nd=?{Difficulté ?|} }}'></button>
		<hr/>
		</div>
        <div class="col">
        	<label class="oneline">PV</label>
    	    <input type="number" name="attr_PV" />
    	    <span class='dee'>/</span>
    	    <input type="number" name="attr_PV_max" />
            <br/>
    	    <label class="oneline">PE</label>
        	<input type="number" name="attr_PE" />
        	<span class='dee'>/</span>
        	<input type="number" name="attr_PE_max" />
        	<br/>
        	<label class="oneline">B. Physique</label>
        	<input type="number" name="attr_BasePhy" />
        	<br/>
        	<label class="oneline">B. Magique</label>
        	<input type="number" name="attr_BaseMag" />
        	<br/>
        	<label class="oneline">Armure</label>
        	<input type="number" name="attr_Armure" />
        	<br/>
        	<label class="oneline">Résistance</label>
        	<input type="number" name="attr_Resistance" />
        	<br/>
        	<label class="oneline">Défense</label>
        	<input type="number" name="attr_Defense" />
        	<br/>
        	<label class="oneline">Initiative</label>
            <button type='roll' name='roll_OtherPotComp' value='/w gm Initiative de @{character_name}: [[((@{Sag_d}+@{PuissanceNPC})-1)D6+(@{Sag_pip}+floor(@{Agi_d}))+1D6! &{tracker}]]'></button>
        </div>
	</div>
	
    <hr/>
    <h1>Sorts ou techniques tiers</h1>
    <label class="desc-spell-cost">Coût</label>
    <label class="desc-spell-name">Nom</label>
    <label class="desc-spell-rank">Rang</label>
    <label class="desc-spell-desc">Description</label>
    <fieldset class="repeating_allOtherDons-spells">
        <div class="spell-row"> 
            <input type="number" name="attr_other_don_spell_cost" value="1" min="0"/>
            <input type="text" name="attr_other_don_spell_name" placeholder="Nom" />
            <input type="number" name="attr_other_don_spell_level" value="1" min="1"/>
            <input class="long-desc" type="text" name="attr_other_don_spell_desc" placeholder="Description/Effet"/>
        </div>
    </fieldset>
    <hr/>
    <h1>Loot</h1>
    <textarea name="attr_equipement" placeholder="Loot ici !"></textarea>
</div>

<div class="page pc">
    
    <input type="text" name="attr_character_name" class="transparent-input editable-title" placeholder="Nom"/>
    <div class="2colrow">
        <div class="col">
    		<label style="width:160px; margin-left:40px">Malus Multi-Action</label><input class="transparent-input" type="number" name="attr_global" value=0 />
    	</div>
    
    
    	<div class="col">
    		<label>Karma</label><input class="transparent-input" type="number" name="attr_karma" value=0 />
    	    <span class='dee'>/</span>
    		<input class="transparent-input" type="number" name="attr_karma_max" value=0 />
    		<br/>
    	</div>
    
    </div>
    <hr/>
    <h1>Caractéristiques</h1>

    <div class="2colrow">
    	<div class="col">
    		<h2>Attributs</h2>
    		<div class="attributes">
	            <div class="top">
                    <span class="label" style="margin-left:15px;width: 120px;">Nom de l'attribut</span>
                    <span class="label" style="width: 25px;">Dés</span>
                    <span class="label" style="width: 50px;">Points</span>
                </div>
                <div class="display">
                    <span class="attributes-display">Force</span>
                    <input type="number" name='attr_For_d' value='0' min="0" />
                    <input type="number" name='attr_For_pip' value="0" min="0"/>
                    <button type='roll' name='roll_jetFor' value='!wd [[(@{For_d}+@{global})D6+@{For_pip}]] {{carac=Force}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
                <div class="display">
                    <span class="attributes-display">Dextérité</span>
                    <input type="number" name='attr_Dex_d' value='0' min="0" />
                    <input type="number" name='attr_Dex_pip' value="0" min="0"/>
                    <button type='roll' name='roll_jetDex' value='!wd [[(@{Dex_d}+@{global})D6+@{Dex_pip}]] {{carac=Dextérité}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
                <div class="display">
                    <span class="attributes-display">Agilité</span>
                    <input type="number" name='attr_Agi_d' value='0' min="0" />
                    <input type="number" name='attr_Agi_pip' value="0" min="0"/>
                    <button type='roll' name='roll_jetAgi' value='!wd [[(@{Agi_d}+@{global})D6+@{Agi_pip}]] {{carac=Agilité}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
                <div class="display">
                    <span class="attributes-display">Constitution</span>
                    <input type="number" name='attr_Con_d' value='0' min="0" />
                    <input type="number" name='attr_Con_pip' value="0" min="0"/>
                    <button type='roll' name='roll_jetCon' value='!wd [[(@{Con_d}+@{global})D6+@{Con_pip}]] {{carac=Constitution}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
                <div class="display">
                    <span class="attributes-display">Intelligence</span>
                    <input type="number" name='attr_Int_d' value='0' min="0" />
                    <input type="number" name='attr_Int_pip' value="0" min="0"/>
                    <button type='roll' name='roll_jetInt' value='!wd [[(@{Int_d}+@{global})D6+@{Int_pip}]] {{carac=Intelligence}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
                <div class="display">
                    <span class="attributes-display">Sagesse</span>
                    <input type="number" name='attr_Sag_d' value='0' min="0" />
                    <input type="number" name='attr_Sag_pip' value="0" min="0"/>
                    <button type='roll' name='roll_jetSag' value='!wd [[(@{Sag_d}+@{global})D6+@{Sag_pip}]] {{carac=Sagesse}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
                <div class="display">
                    <span class="attributes-display">Charisme</span>
                    <input type="number" name='attr_Cha_d' value='0' min="0" />
                    <input type="number" name='attr_Cha_pip' value="0" min="0"/>
                    <button type='roll' name='roll_jetCha' value='!wd [[(@{Cha_d}+@{global})D6+@{Cha_pip}]] {{carac=Charisme}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
                <div class="display">
                    <span class="attributes-display">Potentiel</span>
                    <input type="number" name='attr_Pot_d' value='0' min="0" />
                    <input type="number" name='attr_Pot_pip' value="0" min="0"/>
                    <button type='roll' name='roll_jetPot' value='!wd [[(@{Pot_d}+@{global})D6+@{Pot_pip}]] {{carac=Potentiel}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
            </div>
            
    		<h2>Caractéristiques principales</h2>
        	<div class="tooltip desclabel">
        	    <label class="oneline">P. de vie</label>
        	    <span class="tooltiptext"><b>Points de vie</b></span>
    	    </div>
    	    <input type="number" class="transparent-input" name="attr_PV"/>
    	    <span class='dee'>/</span>
    	    <input type="number" name="attr_PV_max" readonly />
            <br/>
        	<div class="tooltip desclabel">
        	    <label class="oneline">P. d'énergie</label>
        	    <span class="tooltiptext"><b>Points d'énergie</b></span>
        	</div>
        	<input type="number" class="transparent-input" name="attr_PE"/>
        	<span class='dee'>/</span>
        	<input type="number" name="attr_PE_max" readonly />
        	
    	    <h2>Caractéristiques offensives</h2>
    		<div class="tooltip desclabel">
        	    <label>Physique</label>
        	    <span class="tooltiptext">
        	        <b>Base aux dégâts physiques</b><br/><br/>Dégâts physiques infligés de base lors d'une frappe ou avec une arme implicant la puissance brute du personnage
    	        </span>
            </div>
        	<span class='dee'>+</span><input class="transparent-input" type="number" name="attr_BonusBasePhy" /><span class='dee'>=</span><input type="number" name="attr_BasePhy" readonly/>
            <br/>
        	<div class="tooltip desclabel">
    	        <label>Magique</label>
    	        <span class="tooltiptext">
    	            <b>Base aux dégâts magiques</b><br/><br/>Dégâts magiques infligés de base lorsqu'un sort est lancé ou lorsqu'une arme magique impliquant la puissance magique du personnage est utilisée
                </span>
            </div>
        	<span class='dee'>+</span><input class="transparent-input" type="number" name="attr_BonusBaseMag" /><span class='dee'>=</span><input type="number" name="attr_BaseMag" readonly />
        	<br/>
        	<label class="desclabel">Initiative</label>
            <button type='roll' name='roll_OtherPotComp' value='Initiative de @{character_name}: [[(@{Sag_d}-1)D6+(@{Sag_pip}+floor(@{Agi_d}/4))+1D6! &{tracker}]]'></button>
    	
    	<h2>Carractéristiques défensives</h2>
        	<div class="tooltip desclabel">
        	    <label>Armure</label>
        	    <span class="tooltiptext">
        	        <b>Armure physique</b><br/><br/>Réduction fixe des dégâts physiques infligés
        	    </span>
        	</div>
            <span class='dee'>+</span><input class="transparent-input" type="number" name="attr_BonusArmure" /><span class='dee'>=</span><input type="number" name="attr_Armure" readonly />
            <br/>
            
        	<div class="tooltip desclabel">
        	    <label>Résistance</label>
        	    <span class="tooltiptext">
        	        <b>Résistance magique</b><br/><br/>Réduction fixe des dégâts magiques infligés
        	    </span>
        	</div>
        	<span class='dee'>+</span><input class="transparent-input" type="number" name="attr_BonusResistance" /><span class='dee'>=</span><input type="number" name="attr_Resistance" readonly />
            <br/>
            
        	<div class="tooltip desclabel">
        	    <label>Défense</label>
        	    <span class="tooltiptext">
        	        <b>Défense passive</b><br/><br/>Equivalent de la classe d'armure : Valeur qu'un opposant doit dépasser par défaut lors d'une attaque
        	    </span>
        	</div>
        	<span class='dee'>+</span><input class="transparent-input" type="number" name="attr_BonusDefense" /><span class='dee'>=</span><input type="number" name="attr_Defense" readonly />

            <!--<h2>Aspects</h2>
            
        	<div class="attributes">
        	    <div class="top">
                    <span class="label" style="margin-left:15px;width: 155px;">Nom de l'aspect</span>
                    <span class="label" style="width: 12px;">Rang</span>
                </div>
                <fieldset class="repeating_aspects">
                    <div class="display">
                        <input type="text" class="skills-display" name="attr_aspect_nom"/>
                        <input type="number" name='attr_aspect_rank' value='0' min="0" />
                        <textarea class="transparent-input desc-don" style="width:100%; height: 17px; margin-top:2px;min-height: 17px; resize: vertical;"
                            placeholder="Description"></textarea>
                    </div>
                </fieldset>
            </div>-->
    	</div>
    	<div class="col">
    	    <h2>Compétences</h2>
    		<div class="skills">
	            <div class="top">
                    <span class="label" style="margin-left:15px;width: 93px;">Nom de la compétence</span>
                    <span class="label" style="width: 10px;">Dés</span>
                    <span class="label" style="width: 22px;">Points</span>
                    <span class="label" style="width: 80px;">Attribut</span>
                </div>
                <div class="display">
                    <span class="skill-display">Puissance Physique</span>
                    <input type="number" name='attr_PuissancePhysiqueComp_d' value='0' min="0" />
                    <input type="number" name='attr_PuissancePhysiqueComp_pip' value="0" min="0"/>
                    <select name="attr_PuissancePhysiqueAttr">
                        <option value="@{For_d}D6+@{For_pip}" class="forlbl" selected>Force</option>
                        <option value="@{Dex_d}D6+@{Dex_pip}" class="dexlbl">Dextérité</option>
                        <option value="@{Agi_d}D6+@{Agi_pip}" class="agilbl">Agilité</option>
                        <option value="@{Con_d}D6+@{Con_pip}" class="conlbl">Constitution</option>
                        <option value="@{Int_d}D6+@{Int_pip}" class="intlbl">Intelligence</option>
                        <option value="@{Sag_d}D6+@{Sag_pip}" class="saglbl">Sagesse</option>
                        <option value="@{Cha_d}D6+@{Cha_pip}" class="chalbl">Charisme</option>
                        <option value="@{Pot_d}D6+@{Pot_pip}" class="potlbl">Potentiel</option>
                    </select>
                    <button type='roll' name='roll_PuissancePhysiqueComp' value='!wd [[@{PuissancePhysiqueAttr}+(@{PuissancePhysiqueComp_d}+@{global})D6+@{PuissancePhysiqueComp_pip}]] {{carac=Puissance Physique}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
                <div class="display">
                    <span class="skill-display">Combat Mêlée</span>
                    <input type="number" name='attr_CombatMeleeComp_d' value='0' min="0" />
                    <input type="number" name='attr_CombatMeleeComp_pip' value="0" min="0"/>
                    <select name="attr_CombatMeleeAttr">
                        <option value="@{For_d}D6+@{For_pip}" class="forlbl">Force</option>
                        <option value="@{Dex_d}D6+@{Dex_pip}" class="dexlbl" selected>Dextérité</option>
                        <option value="@{Agi_d}D6+@{Agi_pip}" class="agilbl">Agilité</option>
                        <option value="@{Con_d}D6+@{Con_pip}" class="conlbl">Constitution</option>
                        <option value="@{Int_d}D6+@{Int_pip}" class="intlbl">Intelligence</option>
                        <option value="@{Sag_d}D6+@{Sag_pip}" class="saglbl">Sagesse</option>
                        <option value="@{Cha_d}D6+@{Cha_pip}" class="chalbl">Charisme</option>
                        <option value="@{Pot_d}D6+@{Pot_pip}" class="potlbl">Potentiel</option>
                    </select>
                    <button type='roll' name='roll_CombatMeleeComp' value='!wd [[@{CombatMeleeAttr}+(@{CombatMeleeComp_d}+@{global})D6+@{CombatMeleeComp_pip}]] {{carac=Combat Mêlée}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
                <div class="display">
                    <span class="skill-display">Tir</span>
                    <input type="number" name='attr_TirComp_d' value='0' min="0" />
                    <input type="number" name='attr_TirComp_pip' value="0" min="0"/>
                    <select name="attr_TirAttr">
                        <option value="@{For_d}D6+@{For_pip}" class="forlbl">Force</option>
                        <option value="@{Dex_d}D6+@{Dex_pip}" class="dexlbl" selected>Dextérité</option>
                        <option value="@{Agi_d}D6+@{Agi_pip}" class="agilbl">Agilité</option>
                        <option value="@{Con_d}D6+@{Con_pip}" class="conlbl">Constitution</option>
                        <option value="@{Int_d}D6+@{Int_pip}" class="intlbl">Intelligence</option>
                        <option value="@{Sag_d}D6+@{Sag_pip}" class="saglbl">Sagesse</option>
                        <option value="@{Cha_d}D6+@{Cha_pip}" class="chalbl">Charisme</option>
                        <option value="@{Pot_d}D6+@{Pot_pip}" class="potlbl">Potentiel</option>
                    </select>
                    <button type='roll' name='roll_TirComp' value='!wd [[@{TirAttr}+(@{TirComp_d}+@{global})D6+@{TirComp_pip}]] {{carac=Tir}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
                <div class="display">
                    <span class="skill-display">Lancé</span>
                    <input type="number" name='attr_LanceComp_d' value='0' min="0" />
                    <input type="number" name='attr_LanceComp_pip' value="0" min="0"/>
                    <select name="attr_LanceAttr">
                        <option value="@{For_d}D6+@{For_pip}" class="forlbl">Force</option>
                        <option value="@{Dex_d}D6+@{Dex_pip}" class="dexlbl" selected>Dextérité</option>
                        <option value="@{Agi_d}D6+@{Agi_pip}" class="agilbl">Agilité</option>
                        <option value="@{Con_d}D6+@{Con_pip}" class="conlbl">Constitution</option>
                        <option value="@{Int_d}D6+@{Int_pip}" class="intlbl">Intelligence</option>
                        <option value="@{Sag_d}D6+@{Sag_pip}" class="saglbl">Sagesse</option>
                        <option value="@{Cha_d}D6+@{Cha_pip}" class="chalbl">Charisme</option>
                        <option value="@{Pot_d}D6+@{Pot_pip}" class="potlbl">Potentiel</option>
                    </select>
                    <button type='roll' name='roll_LanceComp' value='!wd [[@{LanceAttr}+(@{LanceComp_d}+@{global})D6+@{LanceComp_pip}]] {{carac=Lancé}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
                <div class="display">
                    <span class="skill-display">Esquive</span>
                    <input type="number" name='attr_EsquiveComp_d' value='0' min="0" />
                    <input type="number" name='attr_EsquiveComp_pip' value="0" min="0"/>
                    <select name="attr_EsquiveAttr">
                        <option value="@{For_d}D6+@{For_pip}" class="forlbl">Force</option>
                        <option value="@{Dex_d}D6+@{Dex_pip}" class="dexlbl">Dextérité</option>
                        <option value="@{Agi_d}D6+@{Agi_pip}" class="agilbl" selected>Agilité</option>
                        <option value="@{Con_d}D6+@{Con_pip}" class="conlbl">Constitution</option>
                        <option value="@{Int_d}D6+@{Int_pip}" class="intlbl">Intelligence</option>
                        <option value="@{Sag_d}D6+@{Sag_pip}" class="saglbl">Sagesse</option>
                        <option value="@{Cha_d}D6+@{Cha_pip}" class="chalbl">Charisme</option>
                        <option value="@{Pot_d}D6+@{Pot_pip}" class="potlbl">Potentiel</option>
                    </select>
                    <button type='roll' name='roll_EsquiveComp' value='!wd [[@{EsquiveAttr}+(@{EsquiveComp_d}+@{global})D6+@{EsquiveComp_pip}]] {{carac=Esquive}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
				<div class="display">
                    <span class="skill-display">Stamina</span>
                    <input type="number" name='attr_StaminaComp_d' value='0' min="0" />
                    <input type="number" name='attr_StaminaComp_pip' value="0" min="0"/>
                    <select name="attr_StaminaAttr">
                        <option value="@{For_d}D6+@{For_pip}" class="forlbl">Force</option>
                        <option value="@{Dex_d}D6+@{Dex_pip}" class="dexlbl">Dextérité</option>
                        <option value="@{Agi_d}D6+@{Agi_pip}" class="agilbl">Agilité</option>
                        <option value="@{Con_d}D6+@{Con_pip}" class="conlbl" selected>Constitution</option>
                        <option value="@{Int_d}D6+@{Int_pip}" class="intlbl">Intelligence</option>
                        <option value="@{Sag_d}D6+@{Sag_pip}" class="saglbl">Sagesse</option>
                        <option value="@{Cha_d}D6+@{Cha_pip}" class="chalbl">Charisme</option>
                        <option value="@{Pot_d}D6+@{Pot_pip}" class="potlbl">Potentiel</option>
                    </select>
                    <button type='roll' name='roll_StaminaComp' value='!wd [[@{StaminaAttr}+(@{StaminaComp_d}+@{global})D6+@{StaminaComp_pip}]] {{carac=Stamina}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
				<div class="display">
                    <span class="skill-display">Volonté</span>
                    <input type="number" name='attr_VolonteComp_d' value='0' min="0" />
                    <input type="number" name='attr_VolonteComp_pip' value="0" min="0"/>
                    <select name="attr_VolonteAttr">
                        <option value="@{For_d}D6+@{For_pip}" class="forlbl">Force</option>
                        <option value="@{Dex_d}D6+@{Dex_pip}" class="dexlbl">Dextérité</option>
                        <option value="@{Agi_d}D6+@{Agi_pip}" class="agilbl">Agilité</option>
                        <option value="@{Con_d}D6+@{Con_pip}" class="conlbl">Constitution</option>
                        <option value="@{Int_d}D6+@{Int_pip}" class="intlbl">Intelligence</option>
                        <option value="@{Sag_d}D6+@{Sag_pip}" class="saglbl"  selected>Sagesse</option>
                        <option value="@{Cha_d}D6+@{Cha_pip}" class="chalbl">Charisme</option>
                        <option value="@{Pot_d}D6+@{Pot_pip}" class="potlbl">Potentiel</option>
                    </select>
                    <button type='roll' name='roll_VolonteComp' value='!wd [[@{VolonteAttr}+(@{VolonteComp_d}+@{global})D6+@{VolonteComp_pip}]] {{carac=Volonté}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
				<div class="display">
                    <span class="skill-display">Puissance magique</span>
                    <input type="number" name='attr_PuissanceMagiqueComp_d' value='0' min="0" />
                    <input type="number" name='attr_PuissanceMagiqueComp_pip' value="0" min="0"/>
                    <select name="attr_PuissanceMagiqueAttr">
                        <option value="@{For_d}D6+@{For_pip}" class="forlbl">Force</option>
                        <option value="@{Dex_d}D6+@{Dex_pip}" class="dexlbl">Dextérité</option>
                        <option value="@{Agi_d}D6+@{Agi_pip}" class="agilbl">Agilité</option>
                        <option value="@{Con_d}D6+@{Con_pip}" class="conlbl">Constitution</option>
                        <option value="@{Int_d}D6+@{Int_pip}" class="intlbl">Intelligence</option>
                        <option value="@{Sag_d}D6+@{Sag_pip}" class="saglbl">Sagesse</option>
                        <option value="@{Cha_d}D6+@{Cha_pip}" class="chalbl">Charisme</option>
                        <option value="@{Pot_d}D6+@{Pot_pip}" class="potlbl" selected>Potentiel</option>
                    </select>
                    <button type='roll' name='roll_PuissanceMagiqueComp' value='!wd [[@{PuissanceMagiqueAttr}+(@{PuissanceMagiqueComp_d}+@{global})D6+@{PuissanceMagiqueComp_pip}]] {{carac=Puissance magique}} {{nd=?{Difficulté ?|} }}'></button>
                </div>
				<fieldset class="repeating_Competence">
					<div class="display">
						<input type="text" class="skill-display" name='attr_Competence_nom' style="width: 98px; border-color: transparent;" placeholder="Entrez un nom..." />
						<input type="number" name='attr_Competence_d' value='0' min="0" />
						<input type="number" name='attr_Competence_pip' value="0" min="0"/>
						<select name="attr_CompetenceAttr">
							<option value="@{For_d}D6+@{For_pip}" class="forlbl" selected>Force</option>
							<option value="@{Dex_d}D6+@{Dex_pip}" class="dexlbl">Dextérité</option>
							<option value="@{Agi_d}D6+@{Agi_pip}" class="agilbl">Agilité</option>
							<option value="@{Con_d}D6+@{Con_pip}" class="conlbl">Constitution</option>
							<option value="@{Int_d}D6+@{Int_pip}" class="intlbl">Intelligence</option>
							<option value="@{Sag_d}D6+@{Sag_pip}" class="saglbl">Sagesse</option>
							<option value="@{Cha_d}D6+@{Cha_pip}" class="chalbl">Charisme</option>
							<option value="@{Pot_d}D6+@{Pot_pip}" class="potlbl">Potentiel</option>
						</select>
						<button type='roll' name='roll_CompetenceComp' value='!wd [[@{CompetenceAttr}+(@{Competence_d}+@{global})D6+@{Competence_pip}]] {{carac=@{Competence_nom} }} {{nd=?{Difficulté ?|} }}'></button>
					</div>
				</fieldset>
            </div>
    	</div>
    </div>
    
    <hr/>
    <div class="dons">
        
        <h1>Particularités</h1>
        <div class="2colrow">
            <div class="col" style="width: 30%;">
                <h2>Aspects (Passifs)</h2>
                
            	<div class="aspects">
            	    <div class="top">
                        <span class="label" style="margin-left:10px;width: 202px;">Nom de l'aspect</span>
                        <span class="label" style="width: 12px;">Rang</span>
                    </div>
                    <fieldset class="repeating_aspects">
                        <div class="display">
                            <input type="text" class="transparent-input" name="attr_aspect_nom" style="width:215px; font-weight:bold;"/>
                            <input type="number" name='attr_aspect_rank' value='0' min="0" class="transparent-input" />
                            <textarea class="transparent-input desc-don" style="width:96%; height: 18px; margin-top:2px;min-height: 17px; resize: vertical;"
                                placeholder="Description"></textarea>
                        </div>
                    </fieldset>
                </div>
            </div>
            <div class="col" style="width: 65%;">
                <h2>Dons (Actifs)</h2>
                
            	<div class="subdons">
            	    <div class="top">
                        <span class="label" style="margin-left:10px;width: 162px;">Nom du don</span>
                        <span class="label" style="width: 21px;">Dés</span>
                        <span class="label" style="width: 30px;">Points</span>
                        <span class="label" style="width: 42px;">Dégâts</span>
                        <span class="label" style="width: 100px;">Attributs</span>
                    </div>
                    <fieldset class="repeating_dons">
                        <div class="display">
                            <input type="text" class="subdon-display transparent-input" name="attr_subdon_nom" style="width:175px; font-weight:bold;"/>
                            <input type="number" class="transparent-input" name='attr_subdon_d' value='0' min="0" />
                            <input type="number" class="transparent-input" name='attr_subdon_pip' value='1' min="0" />
                            <select name="attr_subdon_spellattacktype" style="width:auto;">
                                <option value="0" selected>-</option>
                                <option value="@{BasePhy}">P</option>
                                <option value="@{BaseMag}">M</option>
                            </select>
                            
                            <select name="attr_subdon_attr" class="select-don">
                                <option value="@{For_d}D6+@{For_pip}" class="forlbl">Force</option>
                                <option value="@{Dex_d}D6+@{Dex_pip}" class="dexlbl">Dextérité</option>
                                <option value="@{Agi_d}D6+@{Agi_pip}" class="agilbl">Agilité</option>
                                <option value="@{Con_d}D6+@{Con_pip}" class="conlbl">Constitution</option>
                                <option value="@{Sag_d}D6+@{Sag_pip}" class="saglbl">Sagesse</option>
                                <option value="@{Int_d}D6+@{Int_pip}" class="intlbl">Intelligence</option>
                                <option value="@{Cha_d}D6+@{Cha_pip}" class="chalbl">Charisme</option>
                                <option value="@{Pot_d}D6+@{Pot_pip}" class="potlbl">Potentiel</option>
                            </select>
                            
                            <button type='roll' name='roll_compdon' value='!wd [[(@{subdon_d}+@{global})D6+@{subdon_pip}+@{subdon_attr}]] {{carac=@{subdon_nom}}} {{nd=?{Difficulté ?|} }} {{damage=@{subdon_spellattacktype}}}'></button>
                            <textarea class="transparent-input desc-don" style="height: 34px; margin-top:2px;min-height: 17px; resize: vertical;"
                                placeholder="Description"></textarea>
                        </div>
                    </fieldset>
                </div>
            </div>
        </div>
    </div>
    <hr/>
    <h1>Equipements</h1>
    <div class="attacks" style="position: relative; float:left; margin-right: 10px;">
        <h2 class="label" style="margin-top: 0px; bottom: 0px;">Armes</h2>
        <div class="top">
            <span class="label" style="width: 90px; padding-left:5px;">Nom de l'arme</span>
            <span class="label" style="width: 55px;">Dommages</span>
            <span class="label" style="width: 45px;">Portée</span>
        </div>
        <fieldset class="repeating_attack">
            <div class="attack">
                <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"><span>y</span>
                <div class="options">
                    <div class="row">
                        <span>Nom de l'arme :</span>
                        <input type="text" name="attr_atkname">
                    </div>
                    <div class="row">
                        <span>Attaque :</span>
                        <select name="attr_atkattr_base">
                            <option value="@{For_d}D6+@{For_pip}" class="forlbl">Force</option>
                            <option value="(@{PuissancePhysiqueComp_d}+@{For_d}+@{global})D6+(@{PuissancePhysiqueComp_pip}+@{For_pip})" class="forlbl">Puissance Physique</option>
                            <option value="@{Agi_d}D6+@{Agi_pip}" class="dexlbl">Dextérité</option>
                            <option value="(@{CombatMeleeComp_d}+@{Dex_d}+@{global})D6+(@{CombatMeleeComp_pip}+@{Dex_pip})" class="dexlbl">Combat Mêlée</option>
                            <option value="(@{TirComp_d}+@{Dex_d}+@{global})D6+(@{TirComp_pip}+@{Dex_pip})" class="dexlbl">Tir</option>
                            <option value="(@{LanceComp_d}+@{Dex_d}+@{global})D6+(@{LanceComp_pip}+@{Dex_pip})" class="dexlbl">Lancé</option>
                            <option value="0" class="dexlbl">Autre - Voir MJ</option>
                        </select>
                        <span>+</span>
                        <input type="text" class="num" name="attr_atkmod" placeholder="0">
                    </div>
                    <div class="row">
                        <span>Portée :</span>
                        <input type="text" name="attr_atkrange" placeholder="Corps-à-corps/X m" style="width: 170px;">
                    </div>
                    <div class="row">
                        <span>Dommages :</span>
                        <input type="text" name="attr_dmgbase" placeholder="X" style="width: 50px;">
                    </div>
                    <div class="row">
                        <span>Description :</span>
                        <textarea name="attr_atk_desc" class="transparent-input" ></textarea>
                    </div>
                </div>
                <div class="display">
                    <span name="attr_atkname" style="width: 95px;"></span>
                    <input type="text" name="attr_dmgbase" style="width: 60px;" value="">
                    <span name="attr_atkrange" style="width: 30px;"></span>
                    <button type="roll" name="roll_attack" value="!wd [[ @{atkattr_base}+@{atkmod}]] {{carac=@{atkname}}} {{nd=?{Difficulté ?|} }} {{damage=@{dmgbase}+@{BasePhy} }}"></button>
                </div>
            </div>
        </fieldset>
    </div>
    <div class="armors" style="position: relative; float:left; margin-right: 10px;">
        <h2 class="label" style="margin-top: 0px; bottom: 0px;">Armures</h2>
        <div class="top">
            <span class="label" style="width: 7px;">E?</span>
            <span class="label" style="width: 93px;">Nom de l'armure</span>
            <span class="label" style="width: 40px;">Physique</span>
            <span class="label" style="width: 40px;">Magique</span>
        </div>
        <fieldset class="repeating_allarmors">
            <div class="armor">
                <input class="options-flag" type="checkbox" name="attr_options-flag" checked="checked"><span>y</span>
                <div class="options">
                    <div class="row">
                        <span>Nom de l'armure :</span>
                        <input type="text" name="attr_armorname">
                    </div>
                    <div class="row">
                        <span>Armure :</span>
                        <input type="text" name="attr_armor_value" placeholder="" style="width: 50px;">
                        <span style="margin-left:20px;">Résistance :</span>
                        <input type="text" name="attr_resist_value" placeholder="" style="width: 50px;">
                        <span>Malus d'agilité :</span>
                        <input type="text" name="attr_armor_malus" placeholder="" style="width: 50px;">
                    </div>
                    <div class="row">
                        <span>Attaque :</span>
                        <select name="attr_atkattr_base">
                            <option value="@{For_d}D6+@{For_pip}" class="forlbl">Force</option>
                            <option value="(@{PuissancePhysiqueComp_d}+@{For_d}+@{global})D6+(@{PuissancePhysiqueComp_pip}+@{For_pip})" class="forlbl">Puissance Physique</option>
                            <option value="@{Agi_d}D6+@{Agi_pip}" class="dexlbl">Dextérité</option>
                            <option value="(@{CombatMeleeComp_d}+@{Dex_d}+@{global})D6+(@{CombatMeleeComp_pip}+@{Dex_pip})" class="dexlbl">Combat Mêlée</option>
                            <option value="(@{TirComp_d}+@{Dex_d}+@{global})D6+(@{TirComp_pip}+@{Dex_pip})" class="dexlbl">Tir</option>
                            <option value="(@{LanceComp_d}+@{Dex_d}+@{global})D6+(@{LanceComp_pip}+@{Dex_pip})" class="dexlbl">Lancé</option>
                            <option value="0" class="dexlbl">Autre - Voir MJ</option>
                        </select>
                        <span>+</span>
                        <input type="text" class="num" name="attr_atkmod" placeholder="0">
                    </div>
                    <div class="row">
                        <span>Dommages :</span>
                        <input type="text" name="attr_dmgbase" placeholder="-" style="width: 50px;">
                    </div>
                    <div class="row">
                        <span>Description :</span>
                        <textarea name="attr_atk_desc" class="transparent-input" ></textarea>
                    </div>
                </div>
                <div class="display">
                    <input type="checkbox" name="attr_armor_equipped"/>
                    <span name="attr_armorname" style="width: 90px;"></span>
                    <span name="attr_armor_value" style="width: 35px;"></span>
                    <span name="attr_resist_value" style="width: 35px;"></span>
                    <button type="roll" name="roll_attack" value="!wd [[ @{atkattr_base}+@{atkmod}]] {{carac=@{atkname}}} {{nd=?{Difficulté ?|} }} {{damage=@{dmgbase}+@{BasePhy} }}"/>
                </div>
            </div>
        </fieldset>
    </div>
    <div class="equipment">
        <h2 class="label" style="margin-left: 5px; bottom: 0px;">Autres</h2>
        <h6 class="label" style="margin-left: 5px; bottom: 0px;">Pièces :</h6>
        <div class="money">
            <div class="coin coper">
                <span class="label">Cuivre</span>
                <input type="text" name="attr_cp" title="10 => 1 PA">
            </div>
            <div class="coin silver">
                <span class="label">Argent</span>
                <input type="text" name="attr_sp" title="10 => 1 PO">
            </div>
            <div class="coin gold">
                <span class="label">Or</span>
                <input type="text" name="attr_gp" title="10 => 1 PP">
            </div>
            <div class="coin platine">
                <span class="label">Platine</span>
                <input type="text" name="attr_pp">
            </div>
        </div>
        <h6 class="label" style="margin-left: 5px; bottom: 0px;">Objets divers :</h6>
        <div class="complex">
            <div class="top" style="height: auto;">
                <span style="width: 50px; text-align: center; display:inline-block;">Quantité</span>
                <span style="width: 150px; text-align: left; display:inline-block;">Nom de l'objet</span>
            </div>
            <fieldset class="repeating_inventory">
                <input type="hidden" class="equippedflag" name="attr_equipped">
                <div class="item">
                    <input class="weight" type="text" name="attr_itemcount" value="1">
                    <input class="name" type="text" name="attr_itemname">
                </div>
            </fieldset>
        </div>
    </div>
    <input type="hidden" name="attr_TotalArmor"/>
    <input type="hidden" name="attr_TotalResist"/>
    <input type="hidden" name="attr_TotalAgiMalus"/>
    <hr/>
</div>
<div class="page roleplay">
    <h1>Roleplay</h1>
    <div class="2colrow">
        <div class="col">
	        <label class="background-label">Race</label><input type="text" class="transparent-input" name="attr_race" /><br/>
	        <label class="background-label">Langues</label><input type="text" class="transparent-input" name="attr_langues" />
        </div>
        <div class="col">
	        <label class="background-label">Taille</label><input type="text" class="transparent-input" name="attr_taille" /><br/>
	        <label class="background-label">Poids</label><input type="text" class="transparent-input" name="attr_poids" /><br/>
	        <label class="background-label">Âge</label><input type="text" class="transparent-input" name="attr_age" />
        </div>
	</div>
    <div class="2colrow">
        <div class="col">
            <div class="background">
                <span>Personnalité (qualités, défauts, caractère)</span>
                <textarea name="attr_personnalite" class="transparent-input" ></textarea>
            </div>
        </div>
        <div class="col">
            <div class="background">
                <span>Contacts, alliés et ennemis</span>
                <textarea name="attr_contacts" class="transparent-input" ></textarea>
            </div>
        </div>
    </div>
    <div class="2colrow">
        <div class="col">
            <div class="background">
                <span>Goûts</span>
                <textarea name="attr_gouts" class="transparent-input" ></textarea>
            </div>
        </div>
        <div class="col">
            <div class="background">
                <span>Peurs</span>
                <textarea name="attr_peurs" class="transparent-input" ></textarea>
            </div>
        </div>
    </div>
    <div class="background">
        <span>Histoire</span>
        <textarea name="attr_historique" class="transparent-input" style="font-style:italic;" ></textarea>
    </div>
    <div class="background">
        <span>Notes</span>
        <textarea name="attr_notes" class="transparent-input" ></textarea>
    </div>
</div>

<!-- Script Worker -->
<script type="text/worker">

/* ===== PARAMETERS ==========
destination = the name of the attribute that stores the total quantity
section = name of repeating fieldset, without the repeating_
fields = the name of the attribute field to be summed
      can be a single attribute: 'weight'
      or an array of attributes: ['weight','number','equipped']
multiplier (optional) = a multiplier to to entire fieldset total. For instance, if summing coins of weight 0.02, might want to multiply the final total by 0.02.
*/
const repeatingSum = (destination, section, fields, multiplier = 1) => {
    if (!Array.isArray(fields)) fields = [fields];
    getSectionIDs(`repeating_${section}`, idArray => {
        const attrArray = idArray.reduce( (m,id) => [...m, ...(fields.map(field => `repeating_${section}_${id}_${field}`))],[]);
        getAttrs(attrArray, v => {
            console.log("===== values of v: "+ JSON.stringify(v) +" =====");
                 // getValue: if not a number, returns 1 if it is 'on' (checkbox), otherwise returns 0..
            const getValue = (section, id,field) => parseFloat(v[`repeating_${section}_${id}_${field}`], 10) || (v[`repeating_${section}_${id}_${field}`] === 'on' ? 1 : 0); 
            const sumTotal = idArray.reduce((total, id) => total + fields.reduce((subtotal,field) => subtotal * getValue(section, id,field),1),0);
            console.log(sumTotal*multiplier);
            setAttrs({[destination]: sumTotal * multiplier});    
        });
    });
};

/* MAJ PV */
on("change:puissancenpc change:con_d change:con_pip sheet:opened", function() {
    console.log("MAJ PV max");
    getAttrs(["Con_d","Con_pip", "PV_max", "PV", "PuissanceNPC"], function(values) {
        console.log(values);
        let cond = parseInt(values.Con_d, 10) || 0;
        let conpip = parseInt(values.Con_pip, 10) || 0;
        let oldpvmax = parseInt(values.PV_max, 10) || 0;
        let oldpv = parseInt(values.PV, 10) || 0;
        let pnpc = parseInt(values.PuissanceNPC, 10) || 0;
        setAttrs({
            PV_max: Math.max(5, ((pnpc + cond) * 3 + conpip) * 2 + 10),
            PV: Math.max(5, oldpv + (((pnpc + cond) * 3 + conpip) * 2 + 10) - oldpvmax)
        });
    });
});

/* MAJ PE */
on("change:puissancenpc change:pot_d change:pot_pip sheet:opened", function() {
    console.log("MAJ PE max");
    getAttrs(["Pot_d","Pot_pip", "PE_max", "PE", "PuissanceNPC"], function(values) {
        console.log(values);
        let potd = parseInt(values.Pot_d, 10) || 0;
        let potpip = parseInt(values.Pot_pip, 10) || 0;
        let oldpemax = parseInt(values.PE_max, 10) || 0;
        let oldpe = parseInt(values.PE, 10) || 0;
        let pnpc = parseInt(values.PuissanceNPC, 10) || 0;
        setAttrs({
            PE_max: Math.max(0, ((pnpc + potd) * 3 + potpip + 2) * 1),
            PE: Math.max(0, oldpe + (((pnpc + potd) * 3 + potpip + 2) * 1 - oldpemax))
        });
    });
});

/* MAJ Base physique */
on("change:puissancenpc change:bonusbasephy change:for_d change:for_pip change:puissancephysiquecomp_pip change:puissancephysiquecomp_d sheet:opened", function() {
    console.log("MAJ Base Physique");
    getAttrs(["PuissancePhysiqueComp_d","PuissancePhysiqueComp_pip", "For_d", "For_pip", "BonusBasePhy", "PuissanceNPC"], function(values) {
        console.log(values);
        let fds = parseInt(values.For_d, 10) || 0;
        let fpips = parseInt(values.For_pip, 10) || 0;
        let ds = parseInt(values.PuissancePhysiqueComp_d, 10) || 0;
        let pips = parseInt(values.PuissancePhysiqueComp_pip, 10) || 0;
        let bonus = parseInt(values.BonusBasePhy, 10) || 0;
        let pnpc = parseInt(values.PuissanceNPC, 10) || 0;
        setAttrs({
            BasePhy: ds + pnpc + fds + bonus
        });
    });
});

/* MAJ Base magique */
on("change:puissancenpc change:bonusbasemag change:pot_d change:pot_pip change:puissancemagiquecomp_pip change:puissancemagiquecomp_d sheet:opened", function() {
    console.log("MAJ Base magique");
    getAttrs(["PuissanceMagiqueComp_d","PuissanceMagiqueComp_pip", "Pot_d", "Pot_pip", "BonusBaseMag", "PuissanceNPC"], function(values) {
        console.log(values);
        let pds = parseInt(values.Pot_d, 10) || 0;
        let ppips = parseInt(values.Pot_pip, 10) || 0;
        let ds = parseInt(values.PuissanceMagiqueComp_d, 10) || 0;
        let pips = parseInt(values.PuissanceMagiqueComp_pip, 10) || 0;
        let bonus = parseInt(values.BonusBaseMag, 10) || 0;
        let pnpc = parseInt(values.PuissanceNPC, 10) || 0;
        setAttrs({
            BaseMag: ds + pds + pnpc + bonus
        });
    });
});

/* MAJ Armure */
on("change:repeating_allarmors remove:repeating_allarmors sheet:opened", function() {
    repeatingSum("TotalArmor", "allarmors", ["armor_equipped", "armor_value"]);
    repeatingSum("TotalResist", "allarmors", ["armor_equipped", "resist_value"]);
    repeatingSum("TotalAgiMalus", "allarmors", ["armor_equipped", "armor_malus"]);
});

on("change:totalarmor change:bonusarmure change:staminacomp_d sheet:opened", function() {
    console.log("MAJ Armure");
    
    getAttrs(["BonusArmure", "StaminaComp_d", "TotalArmor"], function(values) {
        console.log(values);
        let ba = parseInt(values.BonusArmure, 10) || 0;
        let sc = parseInt(values.StaminaComp_d, 10) || 0;
        let ta = parseInt(values.TotalArmor, 10) || 0;
        setAttrs({
            Armure: Math.floor(ba + sc + ta)
        });
    });
});

on("change:totalresist change:bonusresistance change:volontecomp_d sheet:opened", function() {
    console.log("MAJ Résistance");
    getAttrs(["BonusResistance", "VolonteComp_d", "TotalResist"], function(values) {
        console.log(values);
        let br = parseInt(values.BonusResistance, 10) || 0;
        let vc = parseInt(values.VolonteComp_d, 10) || 0;
        let tr = parseInt(values.TotalResist, 10) || 0;
        setAttrs({
            Resistance: Math.floor(br + vc + tr)
        });
    });
});

/* MAJ Defense */
on("change:puissancenpc change:bonusdefense change:agi_d sheet:opened", function() {
    console.log("MAJ Résistance");
    getAttrs(["BonusDefense", "Agi_d", "PuissanceNPC"], function(values) {
        console.log(values);
        let bd = parseInt(values.BonusDefense, 10) || 0;
        let agid = parseInt(values.Agi_d, 10) || 0;
        let pnpc = parseInt(values.PuissanceNPC, 10) || 0;
        setAttrs({
            Defense: Math.floor(9 + bd + Math.floor((pnpc + agid) / 2))
        });
    });
});

</script>